var sax = require('sax'),
    request = require('request').defaults({
        headers: { 'Connection': 'keep-alive' }
    }),
    translations = require('./lib/translations');


module.exports = function(id, callback) {
    var stream = sax.createStream(true, { trim: true }),
        res = {},
        currentTag;

    id = encodeURIComponent(id);
    request('http://www.wowhead.com/item=' + id + '&xml').pipe(stream);

    stream.on('opentag', function(tag) {
        currentTag = tag.name;

        var key = translations.id[currentTag];

        if (key) {
            res[key] = parseInt(tag.attributes.id, 10);
        }
    });

    stream.on('cdata', text);
    stream.on('text', text);

    stream.on('error', function(err) {
        this._parser.error = null;
        this._parser.resume();
    });

    stream.on('end', function() {
        callback(null, res);
    });

    function text(text) {
        if (currentTag === 'json' || currentTag === 'jsonEquip') {
            return json(text);
        }

        var translate = translations.text[currentTag];

        if (translate) {
            var set = translate(text);
            res[set[0]] = set[1];
        }
    }

    function json(text) {
        var key, num;

        text = JSON.parse('{' + text + '}');

        for (var prop in text) {
            key = translations.json[prop];
            num = parseInt(text[prop], 10);

            if (key) {
                res[key] = num || text[prop];
            }
        }
    }
};
